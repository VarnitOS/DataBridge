<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EY Data Integration - Agent Communication</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        #stats {
            display: flex;
            gap: 30px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        #graph-container {
            flex: 1;
            position: relative;
        }

        .agent-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .agent-node:hover {
            filter: brightness(1.2);
        }

        .agent-circle {
            fill: #667eea;
            stroke: #fff;
            stroke-width: 3;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }

        .agent-circle.active {
            fill: #4ade80;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                filter: drop-shadow(0 4px 6px rgba(74, 222, 128, 0.5));
            }
            50% {
                filter: drop-shadow(0 4px 20px rgba(74, 222, 128, 0.9));
            }
        }

        .agent-label {
            fill: white;
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .agent-type {
            fill: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            text-anchor: middle;
            pointer-events: none;
        }

        .link {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 2;
            pointer-events: none;
        }

        .flow-particle {
            fill: #4ade80;
            filter: drop-shadow(0 0 8px rgba(74, 222, 128, 0.8));
        }

        #event-log {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 70vh;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        #event-log h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #4ade80;
        }

        .event-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 11px;
            border-left: 3px solid #4ade80;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-item.error {
            border-left-color: #ef4444;
        }

        .event-time {
            font-size: 9px;
            opacity: 0.6;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }

        /* Scrollbar styling */
        #event-log::-webkit-scrollbar {
            width: 6px;
        }

        #event-log::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #event-log::-webkit-scrollbar-thumb {
            background: rgba(74, 222, 128, 0.5);
            border-radius: 3px;
        }

        #event-log::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 222, 128, 0.8);
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <h1>🤖 EY Data Integration - Live Agent Communication</h1>
            <div id="stats">
                <div class="stat">
                    <div class="stat-value" id="agent-count">0</div>
                    <div class="stat-label">Agents</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="event-count">0</div>
                    <div class="stat-label">Events</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="active-count">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="connection-status">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">Connecting...</span>
                </div>
            </div>
        </div>
        
        <div id="graph-container">
            <svg id="graph"></svg>
            
            <div id="event-log">
                <h3>📋 Live Event Log</h3>
                <div id="event-list"></div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const ws = new WebSocket(`ws://${window.location.hostname}:8001/ws`);
        const agents = new Map();
        const events = [];
        let eventCount = 0;
        let activeAgents = new Set();

        // Graph setup
        const svg = d3.select('#graph');
        const width = window.innerWidth;
        const height = window.innerHeight - 100;
        svg.attr('width', width).attr('height', height);

        const g = svg.append('g');
        const linksGroup = g.append('g');
        const nodesGroup = g.append('g');

        // Agent colors by type
        const agentColors = {
            'snowflake': '#4ade80',
            'gemini': '#f59e0b',
            'merge': '#06b6d4',
            'quality': '#8b5cf6',
            'orchestration': '#ec4899',
            'default': '#667eea'
        };

        // WebSocket event handlers
        ws.onopen = () => {
            console.log('WebSocket connected');
            updateStatus('connected', 'Connected');
            ws.send('get_agents');
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
            updateStatus('disconnected', 'Disconnected');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            console.log('Received:', message);

            if (message.type === 'agent_registry') {
                initializeAgents(message.data);
            } else if (message.type === 'history') {
                message.events.forEach(evt => processEvent(evt));
            } else {
                processEvent(message);
            }
        };

        function updateStatus(status, text) {
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (status === 'connected') {
                dot.classList.remove('disconnected');
            } else {
                dot.classList.add('disconnected');
            }
            statusText.textContent = text;
        }

        function initializeAgents(registryData) {
            // Clear existing agents
            agents.clear();

            // Create agent nodes from registry
            registryData.agents.forEach((agentId, index) => {
                const agentType = agentId.split('_')[0]; // Extract type from ID
                agents.set(agentId, {
                    id: agentId,
                    type: agentType,
                    color: agentColors[agentType] || agentColors.default,
                    x: 0,
                    y: 0
                });
            });

            updateAgentPositions();
            renderGraph();
            updateStats();
        }

        function updateAgentPositions() {
            const agentArray = Array.from(agents.values());
            const count = agentArray.length;
            
            // Arrange agents in a circle
            const radius = Math.min(width, height) * 0.35;
            const centerX = width / 2;
            const centerY = height / 2;

            agentArray.forEach((agent, i) => {
                const angle = (i / count) * 2 * Math.PI - Math.PI / 2;
                agent.x = centerX + radius * Math.cos(angle);
                agent.y = centerY + radius * Math.sin(angle);
            });
        }

        function renderGraph() {
            // Clear previous render
            nodesGroup.selectAll('*').remove();

            // Render agent nodes
            const agentArray = Array.from(agents.values());

            const nodeGroups = nodesGroup.selectAll('.agent-node')
                .data(agentArray, d => d.id)
                .join('g')
                .attr('class', 'agent-node')
                .attr('transform', d => `translate(${d.x},${d.y})`);

            nodeGroups.append('circle')
                .attr('class', 'agent-circle')
                .attr('r', 40)
                .style('fill', d => d.color);

            nodeGroups.append('text')
                .attr('class', 'agent-label')
                .attr('dy', -5)
                .text(d => d.id.split('_')[0]);

            nodeGroups.append('text')
                .attr('class', 'agent-type')
                .attr('dy', 10)
                .text(d => d.id.replace(d.id.split('_')[0] + '_', ''));
        }

        function processEvent(event) {
            eventCount++;
            events.push(event);

            if (event.type === 'agent_call') {
                animateFlow(event.data.from_agent, event.data.to_agent);
                markAgentActive(event.data.to_agent);
                logEvent(event);
            } else if (event.type === 'agent_response') {
                animateFlow(event.data.from_agent, event.data.to_agent, true);
                unmarkAgentActive(event.data.from_agent);
                logEvent(event);
            } else if (event.type === 'agent_error') {
                logEvent(event, true);
                unmarkAgentActive(event.data.from_agent);
            }

            updateStats();
        }

        function animateFlow(fromId, toId, isResponse = false) {
            const fromAgent = agents.get(fromId);
            const toAgent = agents.get(toId);

            if (!fromAgent || !toAgent) return;

            // Create flowing particle
            const particle = g.append('circle')
                .attr('class', 'flow-particle')
                .attr('r', 6)
                .attr('cx', fromAgent.x)
                .attr('cy', fromAgent.y);

            // Animate particle along path
            particle.transition()
                .duration(800)
                .ease(d3.easeCubicInOut)
                .attr('cx', toAgent.x)
                .attr('cy', toAgent.y)
                .on('end', function() {
                    d3.select(this).remove();
                });

            // Draw temporary connection line
            const line = linksGroup.append('line')
                .attr('class', 'link')
                .attr('x1', fromAgent.x)
                .attr('y1', fromAgent.y)
                .attr('x2', toAgent.x)
                .attr('y2', toAgent.y)
                .style('stroke', isResponse ? '#4ade80' : '#06b6d4')
                .style('stroke-width', 3)
                .style('opacity', 0);

            line.transition()
                .duration(200)
                .style('opacity', 0.6)
                .transition()
                .duration(600)
                .style('opacity', 0)
                .on('end', function() {
                    d3.select(this).remove();
                });
        }

        function markAgentActive(agentId) {
            activeAgents.add(agentId);
            nodesGroup.selectAll('.agent-node')
                .filter(d => d.id === agentId)
                .select('.agent-circle')
                .classed('active', true);
        }

        function unmarkAgentActive(agentId) {
            activeAgents.delete(agentId);
            nodesGroup.selectAll('.agent-node')
                .filter(d => d.id === agentId)
                .select('.agent-circle')
                .classed('active', false);
        }

        function logEvent(event, isError = false) {
            const eventList = document.getElementById('event-list');
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item' + (isError ? ' error' : '');

            let message = '';
            if (event.type === 'agent_call') {
                message = `📤 ${event.data.from_agent} → ${event.data.to_agent}<br>Tool: ${event.data.tool_name}`;
            } else if (event.type === 'agent_response') {
                message = `✅ ${event.data.from_agent} → ${event.data.to_agent}<br>Completed: ${event.data.tool_name}`;
            } else if (event.type === 'agent_error') {
                message = `❌ ${event.data.from_agent}<br>Error: ${event.data.error}`;
            }

            const time = new Date(event.timestamp).toLocaleTimeString();
            eventItem.innerHTML = `
                ${message}
                <div class="event-time">${time}</div>
            `;

            eventList.insertBefore(eventItem, eventList.firstChild);

            // Keep only last 50 events
            while (eventList.children.length > 50) {
                eventList.removeChild(eventList.lastChild);
            }
        }

        function updateStats() {
            document.getElementById('agent-count').textContent = agents.size;
            document.getElementById('event-count').textContent = eventCount;
            document.getElementById('active-count').textContent = activeAgents.size;
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight - 100;
            svg.attr('width', newWidth).attr('height', newHeight);
            updateAgentPositions();
            renderGraph();
        });

        // Periodically ping server to keep connection alive
        setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send('ping');
            }
        }, 30000);
    </script>
</body>
</html>
